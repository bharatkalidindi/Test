<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Interactive Abacus Tutor</title>
    <style>
        :root {
            --background-color: #f0f2f5;
            --frame-color: #ffffff;
            --rod-color: #d1d5db;
            --bar-color: #4b5563;
            --earth-bead-color: #2563eb;
            --heaven-bead-color: #16a34a;
            --text-color: #111827;
            
            /* Tutorial Colors */
            --tutorial-focus-color: #f59e0b; /* Amber 500 */
            --tutorial-context-color: #38bdf8; /* Sky 400 */
            --tutorial-source-color: #22c55e; /* Green 500 */
            --current-step-bg: #e0e7ff;
            
            --bead-size: 40px;
            --bar-height: 20px;
            --bead-move-distance: 48px;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 20px 10px;
            overflow-y: auto;
            touch-action: manipulation;
        }
        
        #app-controls { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .control-btn {
            min-width: 50px; height: 50px; padding: 0 20px; border-radius: 25px; border: 2px solid var(--bar-color);
            background-color: var(--frame-color); color: var(--bar-color); font-size: 1.5em; font-weight: bold;
            cursor: pointer; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.15s ease, background-color 0.15s ease;
        }
        .control-btn:hover { background-color: #e5e7eb; }
        .control-btn:active { transform: scale(0.95); }
        .control-btn.circle { width: 50px; padding: 0; border-radius: 50%; }

        #abacus-collection { display: flex; flex-direction: column; align-items: center; gap: 30px; }
        .abacus-container { display: flex; flex-direction: column; align-items: center; box-sizing: border-box; width: 100%; max-width: 800px; }

        .result-display {
            background-color: var(--frame-color); border: 2px solid #e5e7eb; border-radius: 12px; padding: 12px 24px;
            font-size: 2.5em; font-weight: 600; color: var(--text-color); margin-bottom: 15px; width: 100%;
            max-width: 600px; text-align: right; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); letter-spacing: 2px; box-sizing: border-box;
        }

        .calculation-display {
            display: none; width: 100%; max-width: 600px; justify-content: center;
            align-items: center; gap: 10px; margin-bottom: 15px;
        }
        .calculation-display .value-box {
            background-color: var(--frame-color); border: 2px solid #e5e7eb; border-radius: 12px; padding: 10px 15px;
            font-size: 1.8em; font-weight: 600; color: var(--text-color); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            text-align: center;
            flex-grow: 1;
        }
        .calculation-display .symbol { font-size: 2em; font-weight: 500; color: var(--bar-color); }

        .abacus-frame { display: flex; justify-content: space-around; background-color: var(--frame-color); border: 2px solid #e5e7eb; border-radius: 16px; padding: 20px 10px; width: 100%; height: 320px; position: relative; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
        .center-bar { position: absolute; width: 100%; height: var(--bar-height); background-color: var(--bar-color); top: 30%; left: 0; z-index: 1; border-radius: 6px; }
        .rod { display: flex; flex-direction: column; justify-content: space-between; align-items: center; width: 6px; height: 100%; background-color: var(--rod-color); border-radius: 3px; position: relative; }
        
        .upper-deck, .lower-deck { display: flex; flex-direction: column; }
        .upper-deck { height: 30%; justify-content: flex-start; }
        .lower-deck { height: 70%; justify-content: flex-end; padding-top: var(--bar-height); box-sizing: border-box; }

        .bead {
            width: var(--bead-size); height: var(--bead-size); border-radius: 50%; cursor: pointer; z-index: 2;
            position: relative; margin: 5px 0; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s ease;
        }
        
        .earth-bead { background-color: var(--earth-bead-color); }
        .heaven-bead { background-color: var(--heaven-bead-color); }
        .bead.highlight { transform: scale(1.1); }
        
        .bead.tutorial-focus { background-color: var(--tutorial-focus-color) !important; transform: scale(1.15); }
        .bead.tutorial-context { background-color: var(--tutorial-context-color) !important; }
        .bead.tutorial-source { background-color: var(--tutorial-source-color) !important; }

        .upper-deck .bead.active { transform: translateY(var(--bead-move-distance)); }
        .lower-deck .bead.active { transform: translateY(calc(-1 * var(--bead-move-distance))); }

        .instruction-panel {
            display: none; width: 100%; max-width: 600px; margin-top: 15px; background-color: var(--frame-color);
            border-radius: 12px; padding: 15px 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); border: 2px solid #e5e7eb; box-sizing: border-box;
        }
        .instruction-panel h3 { margin: 0 0 10px; color: var(--text-color); }
        .instruction-panel ol { padding-left: 20px; margin: 0; }
        .instruction-panel li { margin-bottom: 8px; padding: 8px; border-radius: 6px; transition: background-color 0.3s ease; }
        .instruction-panel li.current-step { background-color: var(--current-step-bg); font-weight: 600; }
        
        .tutorial-nav { display: none; margin-top: 10px; gap: 15px; justify-content: flex-end; }
        .tutorial-nav button { background-color: var(--earth-bead-color); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer; }
        .tutorial-nav button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .tutorial-nav .exit-btn { background-color: #ef4444; }

        .tutorial-legend { margin-top: 15px; padding-top: 10px; border-top: 1px solid #e5e7eb; font-size: 0.9em; color: #4b5563; }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .legend-color-swatch { width: 15px; height: 15px; border-radius: 50%; margin-right: 8px; border: 1px solid rgba(0,0,0,0.1); }
        .swatch-green { background-color: var(--tutorial-source-color); }
        .swatch-yellow { background-color: var(--tutorial-focus-color); }
        .swatch-lightblue { background-color: var(--tutorial-context-color); }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--frame-color); padding: 20px; border-radius: 15px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .modal-content h2 { margin-top: 0; }
        .modal-content ul { list-style: none; padding: 0; }
        .modal-content li button { width: 100%; background: none; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; text-align: left; font-size: 1.1em; cursor: pointer; transition: background-color 0.2s ease; }
        .modal-content li button:hover { background-color: #f0f2f5; }
        
        @media (max-width: 600px) {
            :root { --bead-size: 35px; --bead-move-distance: 40px; }
            .result-display, .calculation-display .value-box { font-size: 1.5em; }
            .calculation-display .symbol { font-size: 1.8em; }
        }
    </style>
</head>
<body>

    <div id="app-controls">
        <button id="examples-btn" class="control-btn">Examples</button>
        <button id="add-abacus-btn" class="control-btn circle">+</button>
        <button id="remove-abacus-btn" class="control-btn circle">-</button>
    </div>

    <div id="abacus-collection"></div>

    <div id="examples-modal" class="modal">
        <div class="modal-content">
            <h2>Abacus Tutorials</h2>
            <ul id="examples-list">
                <li><button data-tutorial="represent-numbers">1. How to Represent Numbers</button></li>
                <li><button data-tutorial="represent-decimals">2. How to Represent Decimals</button></li>
                <li><button data-tutorial="addition">3. How to Do Addition</button></li>
                <li><button data-tutorial="subtraction">4. How to Do Subtraction</button></li>
                <li><button data-tutorial="multi-1-digit">5. Multiplication (1-Digit)</button></li>
                <li><button data-tutorial="multi-2-digit">6. Multiplication (2-Digit)</button></li>
                <li><button data-tutorial="multi-3-digit">7. Multiplication (3-Digit)</button></li>
                <li><button data-tutorial="div-1-digit">8. Division (1-Digit)</button></li>
                <li><button data-tutorial="div-2-digit">9. Division (2-Digit)</button></li>
                <li><button data-tutorial="sqrt-4-digit">10. Square Root (4-Digit)</button></li>
            </ul>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const addBtn = document.getElementById('add-abacus-btn');
        const removeBtn = document.getElementById('remove-abacus-btn');
        const collection = document.getElementById('abacus-collection');
        const examplesBtn = document.getElementById('examples-btn');
        const examplesModal = document.getElementById('examples-modal');
        const examplesList = document.getElementById('examples-list');
        const NUM_RODS = 13;
        
        const MULTIPLICATION_LEGEND_HTML = `
            <div class="tutorial-legend">
                <p style="margin:0 0 5px; font-weight:bold;">Color Key:</p>
                <div class="legend-item"><span class="legend-color-swatch swatch-green"></span> Source numbers (digits being multiplied)</div>
                <div class="legend-item"><span class="legend-color-swatch swatch-yellow"></span> Target beads (where the result goes)</div>
                <div class="legend-item"><span class="legend-color-swatch swatch-lightblue"></span> Other numbers for context</div>
            </div>`;
        const DIVISION_LEGEND_HTML = `
            <div class="tutorial-legend">
                <p style="margin:0 0 5px; font-weight:bold;">Color Key:</p>
                <div class="legend-item"><span class="legend-color-swatch swatch-green"></span> Divisor</div>
                <div class="legend-item"><span class="legend-color-swatch swatch-yellow"></span> Quotient (the answer)</div>
                <div class="legend-item"><span class="legend-color-swatch swatch-lightblue"></span> Dividend (number being divided)</div>
            </div>`;
        const SQRT_LEGEND_HTML = `
            <div class="tutorial-legend">
                <p style="margin:0 0 5px; font-weight:bold;">Color Key:</p>
                <div class="legend-item"><span class="legend-color-swatch swatch-green"></span> Root (the answer)</div>
                <div class="legend-item"><span class="legend-color-swatch swatch-yellow"></span> Target / Working numbers</div>
                <div class="legend-item"><span class="legend-color-swatch swatch-lightblue"></span> Radicand (remainder)</div>
            </div>`;

        const TUTORIALS = {
            'sqrt-4-digit': { 
                id: 'sqrt-4-digit', title: 'Square Root: √1225', interactive: true, legend: 'sqrt',
                displayConfig: { type: 'sqrt', radicand: {start: 8, end: 12}, root: {start: 0, end: 1} },
                steps: [
                    { instruction: 'Rods are A-M. We group the number in pairs from the right: 12 25. Set **1225** on rods J,K,L,M.', state: '1225', focus: []},
                    { instruction: 'Step 1: Look at the first pair, **12**. The largest square less than or equal to 12 is 9, which is 3². So, the first digit of our root is **3**.', state: '1225', focus: [{rod: 9, style: 'context'}, {rod: 10, style: 'context'}]},
                    { instruction: 'Place **3** on rod B as the first digit of our answer.', state: '0300000001225', focus: [{rod: 0, style: 'focus'}]},
                    { instruction: 'Subtract the square (3²=9) from the first pair (12). 12 - 9 = 3. The remainder is 325.', state: '3000000000325', focus: [{rod: 10, style: 'focus'}]},
                    { instruction: 'Step 2: Double the current root (**3**) to get a trial divisor of **6**. We place it to the left of the remainder for now (e.g. on rod I).', state: '3000000600325', focus: [{rod: 7, style: 'focus'}]},
                    { instruction: 'We need to find a digit X such that (6X) * X is close to 325. Let\'s try X=**5**. (65 * 5 = 325). This is an exact match!', state: '3000000600325', focus: [{rod: 7, style: 'context'},{rod: 10, style: 'context'},{rod: 11, style: 'context'},{rod: 12, style: 'context'}]},
                    { instruction: '**5** is the next digit of our root. Place it on rod B.', state: '3500000600325', focus: [{rod: 1, style: 'focus'}]},
                    { instruction: 'Subtract the result (325) from the remainder. 325 - 325 = 0.', state: '3500000600000', focus: [{rod: 10, style: 'focus'},{rod: 11, style: 'focus'},{rod: 12, style: 'focus'}]},
                    { instruction: 'The remainder is zero. The square root of 1225 is **35**!', state: '3500000001225', focus: []}
                ]
            },
            // Other tutorials condensed for brevity
            'div-1-digit': { id: 'div-1-digit', title: 'Division: 344 ÷ 4', interactive: true, legend: 'division', displayConfig: { type: 'division', dividend: {start: 10, end: 12}, divisor: {start: 0, end: 0}, quotient: {start: 5, end: 7} }, steps: [ { instruction: 'Set Divisor 4 on rod A, Dividend 344 on rods K,L,M.', state: '4000000000344', focus: []},{ instruction: 'How many times does 4 go into 34? 8 times.', state: '4000000000344', focus: [{rod: 0, style: 'source'}, {rod: 10, style: 'context'}, {rod: 11, style: 'context'}]},{ instruction: 'Place 8 on rod H.', state: '4000000800344', focus: [{rod: 5, style: 'focus'}]},{ instruction: 'Subtract 8x4=32 from 34. Remainder is 24.', state: '4000000800024', focus: [{rod: 11, style: 'focus'}, {rod: 12, style: 'focus'}]},{ instruction: 'How many times does 4 go into 24? 6 times.', state: '4000000800024', focus: [{rod: 0, style: 'source'}, {rod: 11, style: 'context'}, {rod: 12, style: 'context'}]},{ instruction: 'Place 6 on rod G and 8 moves to rod F.', state: '4000008600024', focus: [{rod: 6, style: 'focus'}]},{ instruction: 'Subtract 6x4=24. Remainder is 0.', state: '4000008600000', focus: [{rod: 11, style: 'focus'}, {rod: 12, style: 'focus'}]},{ instruction: 'The answer is 86!', state: '4000008600344', focus: []} ]},
            'div-2-digit': { id: 'div-2-digit', title: 'Division: 408 ÷ 12', interactive: true, legend: 'division', displayConfig: { type: 'division', dividend: {start: 10, end: 12}, divisor: {start: 0, end: 1}, quotient: {start: 5, end: 7} }, steps: [ { instruction: 'Set Divisor 12 (A,B) and Dividend 408 (K,L,M).', state: '1200000000408', focus: []},{ instruction: 'How many times does 12 go into 40? 3 times.', state: '1200000000408', focus: [{rod: 0, style: 'source'}, {rod: 1, style: 'source'}, {rod: 10, style: 'context'}, {rod: 11, style: 'context'}]},{ instruction: 'Place 3 on rod H.', state: '1200000300408', focus: [{rod: 5, style: 'focus'}]},{ instruction: 'Subtract 3x12=36 from 40. Remainder is 48.', state: '1200000300048', focus: [{rod: 11, style: 'focus'}, {rod: 12, style: 'focus'}]},{ instruction: 'How many times does 12 go into 48? 4 times.', state: '1200000300048', focus: [{rod: 0, style: 'source'}, {rod: 1, style: 'source'}, {rod: 11, style: 'context'}, {rod: 12, style: 'context'}]},{ instruction: 'Place 4 on rod H and Move 3 to rod G.', state: '1200003400048', focus: [{rod: 6, style: 'focus'}]},{ instruction: 'Subtract 4x12=48. Remainder is 0.', state: '1200003400048', focus: [{rod: 11, style: 'focus'}, {rod: 12, style: 'focus'}]},{ instruction: 'The answer is 34!', state: '1200003400048', focus: []} ]},
            'multi-1-digit': { id: 'multi-1-digit', title: 'Multiplication: 86 x 4', interactive: true, legend: 'multiplication', displayConfig: { type: 'multiplication', multiplicand: {start: 0, end: 1}, multiplier: {start: 12, end: 12}, product: {start: 4, end: 6} }, steps: [ { instruction: 'Set multiplicand 86 (A,B).', state: '8600000000000', focus: []},{ instruction: 'Set multiplier 4 (M).', state: '8600000000004', focus: []},{ instruction: 'Multiply 6 by 4 = 24.', state: '8600000000004', focus: [{rod: 1, style: 'source'}, {rod: 12, style: 'source'}]},{ instruction: 'Place 24 (F,G).', state: '8600024000004', focus: [{rod: 5, style: 'focus'}, {rod: 6, style: 'focus'}]},{ instruction: 'Multiply 8 by 4 = 32 (320).', state: '8600024000004', focus: [{rod: 0, style: 'source'}, {rod: 12, style: 'source'}]},{ instruction: 'Add 320 (E,F).', state: '8600344000004', focus: [{rod: 4, style: 'focus'}, {rod: 5, style: 'focus'}]},{ instruction: 'Clear original numbers.', state: '8600344000004', focus: []},{ instruction: 'The answer is 344!', state: '8600344000004', focus: []} ]},
            'multi-2-digit': { id: 'multi-2-digit', title: 'Multiplication: 34 x 12', interactive: true, legend: 'multiplication', displayConfig: { type: 'multiplication', multiplicand: {start: 0, end: 1}, multiplier: {start: 11, end: 12}, product: {start: 4, end: 6} }, steps: [ { instruction: 'Set 34 (A,B).', state: '3400000000000', focus: []},{ instruction: 'Set 12 (L,M).', state: '3400000000012', focus: []},{ instruction: 'Multiply 4 by 12 = 48.', state: '3400000000012', focus: [{rod: 1, style: 'source'}, {rod: 11, style: 'source'}, {rod: 12, style: 'source'}]},{ instruction: 'Place 48 (F,G).', state: '3400048000012', focus: [{rod: 5, style: 'focus'}, {rod: 6, style: 'focus'}]},{ instruction: 'Multiply 30 by 12 = 360.', state: '3400048000012', focus: [{rod: 0, style: 'source'}, {rod: 11, style: 'source'}, {rod: 12, style: 'source'}]},{ instruction: 'Add 360 (E,F). Requires a carry.', state: '3400408000012', focus: [{rod: 4, style: 'focus'}, {rod: 5, style: 'focus'}]},{ instruction: 'Clear original numbers.', state: '3400408000012', focus: []},{ instruction: 'The answer is 408!', state: '3400408000012', focus: []} ]},
            'represent-numbers': { id: 'represent-numbers', title: 'Representing 472', interactive: true, displayConfig: { type: 'represent', resultNumber: {start: 0, end: 12}}, steps: [ { instruction: 'Represent 4...', state: '0', focus: [{ rod: 10, val: 4, style: 'focus' }] }, { instruction: 'Represent 7...', state: '400', focus: [{ rod: 11, val: 7, style: 'focus' }] }, { instruction: 'Represent 2...', state: '470', focus: [{ rod: 12, val: 2, style: 'focus' }] }, { instruction: 'Result is 472.', state: '472', focus: [] }] },
            'addition': { id: 'addition', title: 'Addition: 128 + 351', interactive: true,displayConfig: { type: 'represent', resultNumber: {start: 0, end: 12}} , steps: [ { instruction: 'Set 128...', state: '128', focus: [] }, { instruction: 'Add 3...', state: '428', focus: [{rod: 10, style: 'focus'}] }, { instruction: 'Add 5...', state: '478', focus: [{rod: 11, style: 'focus'}] }, { instruction: 'Add 1...', state: '479', focus: [{rod: 12, style: 'focus'}] }, { instruction: 'Result is 479!', state: '479', focus: [] }] },
            'subtraction': { id: 'subtraction', title: 'Subtraction: 96 - 42', interactive: true,displayConfig: { type: 'represent', resultNumber: {start: 0, end: 12}}, steps: [ { instruction: 'Set 96.', state: '96', focus: [] }, { instruction: 'Subtract 4...', state: '56', focus: [{rod: 11, style: 'focus'}] }, { instruction: 'Subtract 2...', state: '54', focus: [{rod: 12, style: 'focus'}] }, { instruction: 'Result is 54!', state: '54', focus: [] }] },
            'represent-decimals': { id: 'represent-decimals', title: 'Representing Decimals', interactive: false, text: `To represent decimals, you designate a rod as the "units" rod...` },
            'multi-3-digit': { id: 'multi-3-digit', title: 'Advanced Multiplication (3-Digit)', interactive: false, text: 'Similar to 2-digit multiplication but with more steps...' },
        };

        let abacusInstances = [];

        function createAbacusInstance() {
            const abacusContainer = document.createElement('div'); abacusContainer.className = 'abacus-container';
            const resultDisplay = document.createElement('div'); resultDisplay.className = 'result-display'; resultDisplay.textContent = '0';
            const multiplicationDisplay = document.createElement('div');
            multiplicationDisplay.className = 'calculation-display multiplication-display';
            multiplicationDisplay.innerHTML = `<div class="value-box multiplicand">0</div><span class="symbol">×</span><div class="value-box multiplier">0</div><span class="symbol">=</span><div class="value-box product">0</div>`;
            const divisionDisplay = document.createElement('div');
            divisionDisplay.className = 'calculation-display division-display';
            divisionDisplay.innerHTML = `<div class="value-box dividend">0</div><span class="symbol">÷</span><div class="value-box divisor">0</div><span class="symbol">=</span><div class="value-box quotient">0</div>`;
            const sqrtDisplay = document.createElement('div');
            sqrtDisplay.className = 'calculation-display sqrt-display';
            sqrtDisplay.innerHTML = `<span class="symbol">√</span><div class="value-box radicand">0</div><span class="symbol">=</span><div class="value-box root">0</div>`;
            const abacusFrame = document.createElement('div'); abacusFrame.className = 'abacus-frame'; abacusFrame.innerHTML = '<div class="center-bar"></div>';
            const instructionPanel = document.createElement('div'); instructionPanel.className = 'instruction-panel';
            const tutorialNav = document.createElement('div'); tutorialNav.className = 'tutorial-nav';
            let tutorial = null; let currentStep = 0;

            const setBeads = (rodIndex, digit) => {
                let currentVal = digit; const rod = abacusFrame.querySelectorAll('.rod')[rodIndex]; if (!rod) return;
                rod.querySelectorAll('.bead').forEach(b => b.classList.remove('active'));
                if (currentVal >= 5) { rod.querySelector('.heaven-bead')?.classList.add('active'); currentVal -= 5; }
                for (let j = 0; j < currentVal; j++) { rod.querySelectorAll('.earth-bead')[j]?.classList.add('active'); }
            };
            const setBeadsToNumber = (numStr) => { const p = numStr.padStart(NUM_RODS, '0'); for (let i = 0; i < NUM_RODS; i++) { setBeads(i, parseInt(p[i])); } };
            const getValueFromRods = ({start, end}) => { let s = ''; for (let i = start; i <= end; i++) { let v = 0; const r = abacusFrame.querySelectorAll('.rod')[i]; if (r) r.querySelectorAll('.bead.active').forEach(b => v += parseInt(b.dataset.value)); s += v; } return BigInt(s).toLocaleString(); };
            
			const updateMultiplicationDisplay = (config) => {
                multiplicationDisplay.querySelector('.multiplicand').textContent = getValueFromRods(config.multiplicand);
                multiplicationDisplay.querySelector('.multiplier').textContent = getValueFromRods(config.multiplier);
                multiplicationDisplay.querySelector('.product').textContent = getValueFromRods(config.product);
            };
             const updateDivisionDisplay = (config) => {
                divisionDisplay.querySelector('.dividend').textContent = getValueFromRods(config.dividend);
                divisionDisplay.querySelector('.divisor').textContent = getValueFromRods(config.divisor);
                divisionDisplay.querySelector('.quotient').textContent = getValueFromRods(config.quotient);
            };
            const updateSqrtDisplay = (config) => {
                sqrtDisplay.querySelector('.radicand').textContent = getValueFromRods(config.radicand);
                sqrtDisplay.querySelector('.root').textContent = getValueFromRods(config.root);
            };
			const updateRepresentDisplay = (config) => {
                resultDisplay.textContent = getValueFromRods(config.resultNumber);
            };

            const clearTutorialHighlights = () => abacusFrame.querySelectorAll('.bead').forEach(b => b.classList.remove('tutorial-focus', 'tutorial-context', 'tutorial-source'));
            
            const renderTutorialStep = () => {
                const step = tutorial.steps[currentStep]; clearTutorialHighlights();
                setBeadsToNumber(step.state);
                step.focus.forEach(f => {
                    const rodEl = abacusFrame.querySelectorAll('.rod')[f.rod];
                    if(rodEl) rodEl.querySelectorAll('.bead.active').forEach(b => b.classList.add(`tutorial-${f.style}`));
                });
                abacusFrame.querySelectorAll('.bead.active').forEach(b => { if(!b.classList.contains('tutorial-source') && !b.classList.contains('tutorial-focus')) b.classList.add('tutorial-context') });
                const listItems = instructionPanel.querySelectorAll('li');
                listItems.forEach(li => li.classList.remove('current-step'));
                if(listItems[currentStep]) listItems[currentStep].classList.add('current-step');
                tutorialNav.querySelector('.back-btn').disabled = currentStep === 0;
                tutorialNav.querySelector('.next-btn').disabled = currentStep === tutorial.steps.length - 1;
                if (tutorial.displayConfig?.type === 'multiplication') updateMultiplicationDisplay(tutorial.displayConfig);
                else if (tutorial.displayConfig?.type === 'division') updateDivisionDisplay(tutorial.displayConfig);
                else if (tutorial.displayConfig?.type === 'sqrt') updateSqrtDisplay(tutorial.displayConfig);
				else if (tutorial.displayConfig?.type === 'represent') updateRepresentDisplay(tutorial.displayConfig);
            };

            const playTutorial = (tutorialData) => {
                tutorial = tutorialData; currentStep = 0;
                instructionPanel.style.display = 'block'; tutorialNav.style.display = 'flex';
                tutorialNav.querySelector('.back-btn').style.display = 'inline-block';
                tutorialNav.querySelector('.next-btn').style.display = 'inline-block';
                
                let instructionHTML = `<h3>${tutorial.title}</h3>`;
                if(tutorial.interactive){
                    instructionHTML += `<p style="font-size:0.9em;color:#555;">(Note: Rods are labeled A to M from left to right)</p><ol>`;
                    tutorial.steps.forEach(step => { instructionHTML += `<li>${step.instruction}</li>`; });
                    instructionHTML += `</ol>`;
                } else {
                    instructionHTML += `<p>${tutorial.text}</p>`;
                    tutorialNav.querySelector('.back-btn').style.display = 'none';
                    tutorialNav.querySelector('.next-btn').style.display = 'none';
                }
                instructionPanel.innerHTML = instructionHTML;

                if (tutorial.legend === 'multiplication') instructionPanel.insertAdjacentHTML('beforeend', MULTIPLICATION_LEGEND_HTML);
                if (tutorial.legend === 'division') instructionPanel.insertAdjacentHTML('beforeend', DIVISION_LEGEND_HTML);
                if (tutorial.legend === 'sqrt') instructionPanel.insertAdjacentHTML('beforeend', SQRT_LEGEND_HTML);

                resultDisplay.style.display = 'none';
                multiplicationDisplay.style.display = 'none';
                divisionDisplay.style.display = 'none';
                sqrtDisplay.style.display = 'none';
                if (tutorial.displayConfig?.type === 'multiplication') multiplicationDisplay.style.display = 'flex';
                else if (tutorial.displayConfig?.type === 'division') divisionDisplay.style.display = 'flex';
                else if (tutorial.displayConfig?.type === 'sqrt') sqrtDisplay.style.display = 'flex';
                else resultDisplay.style.display = 'block';

                if (tutorial.interactive) renderTutorialStep();
            };
            
            const exitTutorial = () => {
                tutorial = null;resultDisplay.textContent = '0'; instructionPanel.style.display = 'none'; tutorialNav.style.display = 'none'; instructionPanel.innerHTML = '';
                clearTutorialHighlights(); setBeadsToNumber('0');
                resultDisplay.style.display = 'block'; multiplicationDisplay.style.display = 'none'; divisionDisplay.style.display = 'none'; sqrtDisplay.style.display = 'none';
            };

            tutorialNav.innerHTML = `<button class="exit-btn">Exit</button><button class="back-btn">Back</button><button class="next-btn">Next</button>`;
            tutorialNav.querySelector('.exit-btn').onclick = exitTutorial;
            tutorialNav.querySelector('.back-btn').onclick = () => { if(currentStep > 0) { currentStep--; renderTutorialStep(); } };
            tutorialNav.querySelector('.next-btn').onclick = () => { if(currentStep < tutorial.steps.length - 1) { currentStep++; renderTutorialStep(); } };

            const updateCalculation = () => { let t=0n;abacusFrame.querySelectorAll('.rod').forEach((r,i)=>{let v=0;r.querySelectorAll('.bead.active').forEach(b=>v+=parseInt(b.dataset.value));t+=BigInt(v)*(10n**BigInt(NUM_RODS-1-i))});resultDisplay.textContent=t.toLocaleString()};
            const handleBeadTap = (b)=>{if(tutorial)return;if(b.classList.contains('heaven-bead')){b.classList.toggle('active')}else{const r=b.closest('.rod'),bs=Array.from(r.querySelectorAll('.earth-bead')),x=parseInt(b.dataset.index);if(b.classList.contains('active')){if(!bs[x+1]||!bs[x+1].classList.contains('active'))b.classList.remove('active')}else{if(!bs[x-1]||bs[x-1].classList.contains('active'))b.classList.add('active')}}updateCalculation()};
            abacusFrame.addEventListener('touchstart',(e)=>{if(e.target.classList.contains('bead')){e.preventDefault();const b=e.target;if(tutorial)return;b.classList.add('highlight');const end=()=>{b.classList.remove('highlight');handleBeadTap(b);b.removeEventListener('touchend',end);b.removeEventListener('touchcancel',end)};b.addEventListener('touchend',end);b.addEventListener('touchcancel',end)}});

            for (let i = 0; i < NUM_RODS; i++) { const rod = document.createElement('div'); rod.className = 'rod'; const up = document.createElement('div'); up.className = 'upper-deck'; up.appendChild(createBead(5, i, 0, true)); const low = document.createElement('div'); low.className = 'lower-deck'; for (let j = 0; j < 4; j++) { low.appendChild(createBead(1, i, j, false)); } rod.appendChild(up); rod.appendChild(low); abacusFrame.appendChild(rod); }
            function createBead(v,r,i,h) { const b=document.createElement('div'); b.className='bead '+(h?'heaven-bead':'earth-bead'); b.dataset.value=v;b.dataset.rod=r;b.dataset.index=i; return b; }
            
            abacusContainer.appendChild(resultDisplay);
            abacusContainer.appendChild(multiplicationDisplay);
            abacusContainer.appendChild(divisionDisplay);
            abacusContainer.appendChild(sqrtDisplay);
            abacusContainer.appendChild(abacusFrame);
            abacusContainer.appendChild(instructionPanel);
            abacusContainer.appendChild(tutorialNav);
            collection.appendChild(abacusContainer);
            return { element: abacusContainer, playTutorial };
        }

        addBtn.addEventListener('click', () => abacusInstances.push(createAbacusInstance()));
        removeBtn.addEventListener('click', () => { if (collection.lastChild) { collection.removeChild(collection.lastChild); abacusInstances.pop(); } });
        examplesBtn.addEventListener('click', () => examplesModal.style.display = 'flex');
        examplesModal.addEventListener('click', (e) => { if (e.target === examplesModal) examplesModal.style.display = 'none'; });
        examplesList.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const tutorialId = e.target.dataset.tutorial;
                if (!abacusInstances.length) abacusInstances.push(createAbacusInstance());
                abacusInstances[0].playTutorial(TUTORIALS[tutorialId]);
                examplesModal.style.display = 'none';
            }
        });

        abacusInstances.push(createAbacusInstance());
    });
    </script>
</body>
</html>
