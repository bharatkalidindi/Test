<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Touch Abacus with Proper Lower Beads</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #f4f7ff;
      text-align: center;
    }
    #status {
      margin: 20px;
      font-size: 22px;
      font-weight: bold;
    }
    #warning {
      color: red;
      font-size: 18px;
      font-weight: bold;
      margin: 5px;
      min-height: 20px;
    }
    #abacus {
      display: flex;
      justify-content: center;
      margin-top: 10px;
      user-select: none;
      touch-action: manipulation;
    }
    .column {
      margin: 0 14px;
      position: relative;
      height: 400px;
      width: 60px;
    }
    .rod {
      position: absolute;
      top: 180px;
      left: 50%;
      transform: translateX(-50%);
      width: 8px;
      height: 100%;
      background: #444;
      z-index: -1;
    }
    .beam {
      position: absolute;
      top: 180px;
      left: 0;
      right: 0;
      height: 8px;
      background: #222;
      z-index: 1;
      transition: box-shadow 0.2s;
    }
    .beam.highlight {
      box-shadow: 0 0 20px 5px rgba(255,215,0,0.7);
    }
    .bead {
      width: 50px; height: 50px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: white; font-weight: bold;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      transition: top 0.3s;
    }
    .upper { background: #ff7070; top: 50px; }
    .lower { background: #409eff; }
  </style>
</head>
<body>
<div id="status">Value: 0</div>
<div id="warning"></div>
<div id="abacus"></div>

<script>
const columns = 5; // number of columns
const abacus = document.getElementById("abacus");

class Bead {
  constructor(col, type, el, baseTop, activeTop, beamEl, index){
    this.col = col;
    this.type = type;
    this.el = el;
    this.active = false;
    this.baseTop = baseTop;
    this.activeTop = activeTop;
    this.index = index; // lower bead index
    this.el.style.top = this.baseTop + "px";
    this.beamEl = beamEl;
    el.addEventListener("touchstart", () => this.toggle());
    el.addEventListener("click", () => this.toggle());
  }
  toggle(){
    this.active = !this.active;
    if(this.type==="upper"){
      this.el.style.top = this.active ? this.activeTop : this.baseTop;
    } else {
      // Stack lower beads: higher index stops lower
      const activeBeads = beads.filter(b=>b.col===this.col && b.type==="lower" && b.active);
      const activeCount = activeBeads.length + (this.active ? 1 : 0);
      const topPosition = this.active ? 170 - (activeCount - 1)*55 : this.baseTop;
      this.el.style.top = topPosition;
    }
    this.updateHighlight();
    validateMoves();
    updateValue();
  }
  updateHighlight(){
    if(this.type==="upper" && this.active){
      this.beamEl.classList.add("highlight");
    } else if(this.type==="lower" && this.active){
      this.beamEl.classList.add("highlight");
    } else {
      setTimeout(()=>this.beamEl.classList.remove("highlight"), 300);
    }
  }
}

const beads = [];

// build abacus
for(let c=0;c<columns;c++){
  const colDiv = document.createElement("div");
  colDiv.className="column";

  const rod = document.createElement("div");
  rod.className="rod";
  colDiv.appendChild(rod);

  const beam = document.createElement("div");
  beam.className="beam";
  colDiv.appendChild(beam);

  // upper bead
  const upper = document.createElement("div");
  upper.className="bead upper";
  upper.textContent="5";
  colDiv.appendChild(upper);
  beads.push(new Bead(c,"upper",upper,50,140,beam));

  // lower beads (initially at bottom, stacked properly)
  for(let i=0;i<4;i++){
    const lower = document.createElement("div");
    lower.className="bead lower";
    lower.textContent="1";
    colDiv.appendChild(lower);
    let baseY = 230 + i*55; // stacked from bottom
    beads.push(new Bead(c,"lower",lower,baseY,170 - i*55,beam, i));
  }

  abacus.appendChild(colDiv);
}

function getDigit(col){
  let upper = beads.find(b=>b.col===col && b.type==="upper" && b.active)?5:0;
  let lowers = beads.filter(b=>b.col===col && b.type==="lower" && b.active).length;
  return upper+lowers;
}

function updateValue(){
  let total=0;
  for(let c=0;c<columns;c++){
    total += getDigit(c)*Math.pow(10,columns-1-c);
  }
  document.getElementById("status").textContent = "Value: " + total;
}

function validateMoves(){
  let warning = "";
  for(let c=0;c<columns;c++){
    const lowersActive = beads.filter(b=>b.col===c && b.type==="lower" && b.active).length;
    if(lowersActive>4){
      warning = "Too many lower beads in column "+(c+1);
      break;
    }
  }
  document.getElementById("warning").textContent = warning;
}
</script>
</body>
</html>
